document.addEventListener("DOMContentLoaded",function(){const E=document.querySelectorAll("#booking-form");function f(r){const e=r.value.replace(/\D/g,""),a=e.replace(/(\d{3})(\d{3})(\d{4})/,"$1-$2-$3");e.length>=6&&(r.value=a)}function p(r){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(r)}function i(r,e,a){const c=document.getElementById(`${r}-error-${a}`),o=document.getElementById(`${r}-${a}`);c&&o&&(c.textContent=e,c.classList.remove("hidden"),o.style.borderColor="#ef4444",o.setAttribute("aria-invalid","true"))}function d(r,e){const a=document.getElementById(`${r}-error-${e}`),c=document.getElementById(`${r}-${e}`);a&&c&&(a.classList.add("hidden"),c.style.borderColor="#EECD5C",c.removeAttribute("aria-invalid"))}window.formHelpers=window.formHelpers||{},window.formHelpers.hideError=d,E.forEach(r=>{const e=r.dataset.variant,a=r.querySelector(`#phone-${e}`);a&&a.addEventListener("input",function(){f(this),this.value.length>0&&d("phone",e)});const c=["name","email","street","city","zip","service","consent"];e!=="hero"&&c.push("urgency","description"),c.forEach(o=>{const u=r.querySelector(`#${o}-${e}`);u&&(u.addEventListener("blur",function(){o==="consent"?this.hasAttribute("required")&&!this.checked?i(o,"Please agree to the privacy policy and terms to proceed.",e):d(o,e):this.hasAttribute("required")&&!this.value.trim()?i(o,"This field is required.",e):o==="email"&&this.value&&!p(this.value)?i(o,"Please enter a valid email address.",e):d(o,e)}),u.addEventListener("input",function(){o==="consent"?this.checked&&d(o,e):this.value.length>0&&d(o,e)}))}),r.addEventListener("submit",function(o){o.preventDefault();const u=new FormData(r),t=Object.fromEntries(u);let n=!1;const m=["name","phone","email","street","city","zip","service","consent"];if(e!=="hero"&&m.push("urgency","description"),m.forEach(h=>{d(h,e)}),t.name?.trim()||(i("name","Please enter your full name.",e),n=!0),t.phone?.trim()?/^\d{3}-\d{3}-\d{4}$/.test(t.phone.trim())||(i("phone","Please enter a valid phone number (XXX-XXX-XXXX).",e),n=!0):(i("phone","Please enter your phone number.",e),n=!0),t.street?.trim()||(i("street","Please enter your street address.",e),n=!0),t.city?.trim()||(i("city","Please enter your city.",e),n=!0),t.zip?.trim()?/^\d{5}(-\d{4})?$/.test(t.zip.trim())||(i("zip","Please enter a valid zip code.",e),n=!0):(i("zip","Please enter your zip code.",e),n=!0),t.service||(i("service","Please select the service you need.",e),n=!0),e!=="hero"&&!t.urgency&&(i("urgency","Please select when you need service.",e),n=!0),t.email&&!p(t.email)&&(i("email","Please enter a valid email address.",e),n=!0),t.consent||(i("consent","Please agree to the privacy policy and terms to proceed.",e),n=!0),n){const h=r.querySelector('[aria-invalid="true"]');h&&h.focus();return}const l=r.querySelector('button[type="submit"]'),g=l.textContent;if(l.innerHTML=`
          <svg class="animate-spin -ml-1 mr-3 h-4 w-4 text-current inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="m100 50c0 27.614-22.386 50-50 50s-50-22.386-50-50 22.386-50 50-50 50 22.386 50 50zm-5.147 0c0 24.891-20.076 45.147-45.147 45.147s-45.147-20.256-45.147-45.147 20.076-45.147 45.147-45.147 45.147 20.256 45.147 45.147z"></path>
          </svg>
          Submitting...
        `,l.disabled=!0,l.style.opacity="0.7",typeof grecaptcha>"u"||!window.RECAPTCHA_SITE_KEY){console.error("reCAPTCHA not loaded or site key missing"),alert("Security verification is not available. Please try again later or call us directly."),l.textContent=g,l.disabled=!1,l.style.opacity="1";return}grecaptcha.ready(function(){grecaptcha.execute(window.RECAPTCHA_SITE_KEY,{action:"booking_form"}).then(function(h){console.log("reCAPTCHA token obtained:",h?"Yes":"No");const b=`${t.street.trim()}, ${t.city.trim()}, ${t.state||"NJ"} ${t.zip.trim()}`,w={name:t.name.trim(),email:t.email?.trim()||"",phone:t.phone.trim(),address:b,service:t.service,urgency:t.urgency||"flexible",description:t.description?.trim()||`Service requested: ${t.service}. Customer location: ${b}. ${e==="hero"?"Urgent service needed.":""}`.trim(),recaptchaToken:h};fetch("/api/booking",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(w)}).then(s=>{if(console.log("Response status:",s.status),console.log("Response headers:",s.headers.get("content-type")),console.log("Response URL:",s.url),console.log("Response redirected:",s.redirected),!s.ok)return s.text().then(y=>{throw console.error("HTTP error response body:",y.substring(0,500)),new Error(`HTTP error! status: ${s.status}, body: ${y.substring(0,100)}`)});const v=s.headers.get("content-type");return!v||!v.includes("application/json")?s.text().then(y=>{throw console.error("Non-JSON response received:",y.substring(0,500)),new Error(`Server returned non-JSON response (${v}): ${y.substring(0,100)}`)}):s.json()}).then(s=>{s.success?window.location.href="/thank-you":(console.error("Submission failed:",s.error),alert("Sorry, there was an error submitting your request. Please try again or call us directly."),l.textContent=g,l.disabled=!1,l.style.opacity="1")}).catch(s=>{console.error("Submission error:",s),alert("Sorry, there was a network error. Please try again or call us directly."),l.textContent=g,l.disabled=!1,l.style.opacity="1"})})})})})});window.initAutocomplete=function(){document.querySelectorAll('input[name="street"]').forEach(f=>{const p=f.id.split("-").pop(),i=new google.maps.places.Autocomplete(f,{types:["address"],componentRestrictions:{country:"us"},fields:["address_components","formatted_address"]});i.addListener("place_changed",function(){const d=i.getPlace();if(d.address_components){let r="",e="",a="",c="";d.address_components.forEach(n=>{const m=n.types;m.includes("street_number")?r=n.long_name+" ":m.includes("route")?r+=n.long_name:m.includes("locality")?e=n.long_name:m.includes("administrative_area_level_1")?a=n.short_name:m.includes("postal_code")&&(c=n.long_name)});const o=document.getElementById(`city-${p}`),u=document.getElementById(`state-${p}`),t=document.getElementById(`zip-${p}`);e&&o&&(o.value=e),a&&u&&(u.value=a),c&&t&&(t.value=c),["street","city","zip"].forEach(n=>{window.formHelpers&&typeof window.formHelpers.hideError=="function"&&window.formHelpers.hideError(n,p)})}})})};
